# 积分系统设计说明

## 一、系统概述
积分系统是Mini Sports平台的核心功能之一，用于记录和管理用户在平台上的活动积分，支持积分获取、消耗、等级晋升等功能。

## 二、数据库设计

### 1. 表结构说明

#### points_rule 积分规则表
存储各类行为对应的积分规则，包括获取和消耗规则

#### points_record 积分记录表
记录用户积分变更历史，包括获取和消耗记录

#### points_level 积分等级表
定义积分等级划分标准和对应权益

### 2. 字段说明

#### points_rule 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 规则ID |
| type | varchar(50) | 规则类型(GAIN-获取,COST-消耗) |
| action | varchar(50) | 行为编码 |
| name | varchar(100) | 规则名称 |
| points | int | 积分值 |
| description | varchar(200) | 规则描述 |
| status | tinyint | 状态(0-禁用,1-启用) |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

#### points_record 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 记录ID |
| user_id | bigint | 用户ID |
| rule_id | bigint | 规则ID |
| type | varchar(50) | 类型(GAIN-获取,COST-消耗) |
| points | int | 积分值 |
| balance | int | 变更后余额 |
| description | varchar(200) | 变更说明 |
| ref_id | bigint | 关联业务ID |
| created_at | datetime | 创建时间 |

#### points_level 表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 等级ID |
| code | varchar(50) | 等级编码 |
| name | varchar(100) | 等级名称 |
| min_points | int | 最小积分 |
| max_points | int | 最大积分 |
| description | varchar(200) | 等级说明 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

## 三、核心功能

### 1. 积分获取
- 比赛胜利获取积分
- 比赛平局获取积分

### 2. 积分消耗
- 比赛失败扣减积分

### 3. 等级晋升
- 根据积分自动计算等级
- 等级变更实时通知
- 等级权益自动生效

### 4. 积分排行
- 总积分排行榜
- 周期性积分排行
- 特定赛事积分排行

## 四、业务流程

### 1. 积分获取流程
1. 触发积分获取场景
2. 查询对应积分规则
3. 计算获取积分数
4. 更新用户积分
5. 记录积分变更
6. 检查等级变更
7. 发送变更通知

### 2. 积分消耗流程
1. 发起积分消耗
2. 校验积分余额
3. 冻结所需积分
4. 完成业务操作
5. 扣减冻结积分
6. 记录消耗记录
7. 更新等级信息

### 3. 等级晋升流程
1. 积分变更触发
2. 计算最新积分
3. 查询等级配置
4. 确定目标等级
5. 执行等级变更
6. 发放等级权益
7. 推送晋升通知

## 五、注意事项

1. 积分安全
- 积分变更必须有明确来源
- 重要操作需要添加日志
- 防止积分重复发放

2. 性能优化
- 高频接口添加缓存
- 批量处理大量数据
- 异步处理非实时业务

3. 数据一致性
- 使用事务保证原子性
- 关键流程添加幂等
- 定期数据对账校验